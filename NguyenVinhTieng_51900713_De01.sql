CREATE DATABASE COMPETITION
USE COMPETITION
-- SET FORMAT FOR DATE 
SET DATEFORMAT DMY 
/*#############################################################                                                     PHẦN 1: TẠO CSDL TRÊN SQL SERVER (5đ)
--#############################################################*/
--
--I. Tạo bảng dữ liệu với các thuộc tính và ràng buộc sau (4đ)--------------------------------- TẠO BẢNG
/*.......................................................
  1. Người (ID, CMND, tên, giới tính, ngày sinh, nơi sinh)
  ........................................................*/
CREATE TABLE NGUOI (
	ID				CHAR(12) NOT NULL,
	CMND			CHAR(20),
	TEN				NVARCHAR(255),
	GIOITINH		INT,
	NGAYSINH		DATE,
	NOISINH			NVARCHAR(255),
	-------------------------------------------------
	CONSTRAINT PK_NGUOI PRIMARY KEY(ID),
	CONSTRAINT CHECK_GIOITINH CHECK(GIOITINH IN(0,1)),
	CONSTRAINT CHECK_ID CHECK(ID LIKE ('TS' + '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]') OR 
	ID LIKE('NS' + '[0-9][0-9][0-9][0-9][0-9][0-9]')),
	CONSTRAINT CHECK_NGAYSINH CHECK(NGAYSINH LIKE TRY_CONVERT(DATE,CAST(Ngaysinh AS DATE),105))
);

/*..........................................................
  2. Thí sinh (mã thí sinh, địa chỉ, điện thoại, giới thiệu)
  ..........................................................*/

CREATE TABLE THISINH (
	MATHISINH		CHAR(12) NOT NULL,
	DIACHI			NVARCHAR(255),
	DIENTHOAI		CHAR(20),
	GIOITHIEU		NVARCHAR(MAX),
	---------------------------------------------------
	CONSTRAINT PK_THISINH PRIMARY KEY(MATHISINH),
	CONSTRAINT CHECK_MATHISINH CHECK(MATHISINH LIKE('TS%')),
	CONSTRAINT FK_THISINH_NGUOI FOREIGN KEY(MATHISINH) REFERENCES NGUOI(ID)
);

/*......................................................................
  3. Nghệ sỹ (mã nghệ sỹ, nghệ danh, thành tích, MCFlag, CSFlag, NSFlag)
  ......................................................................*/
CREATE TABLE NGHESY (
	MANGHESY		CHAR(12) NOT NULL,
	NGHEDANH		NVARCHAR(255),
	THANHTICH		NVARCHAR(MAX),
	MCFLAG			INT ,
	CSFLAG			INT,
	NSFLAG			INT,
	-------------------------------------------------------
	CONSTRAINT PK_NGHESY PRIMARY KEY(MANGHESY),
	CONSTRAINT CHECK_MCFLAG CHECK(MCFLAG IN (0,1)),
	CONSTRAINT CHECK_CSFLAG CHECK(CSFLAG IN (0,1)),
	CONSTRAINT CHECK_NSFLAG CHECK(NSFLAG IN (0,1)),
	CONSTRAINT FK_NGHESY_NGUOI FOREIGN KEY(MANGHESY) REFERENCES NGUOI(ID)
);

/*...................................................
  4. Chương trình MC dẫn (mã MC, chương trình đã dẫn)
  ...................................................*/														--	+++++++++++++++++++++++
CREATE TABLE CHUONGTRINHMCDAN (
	MAMC				CHAR(12) NOT NULL,
	CHUONGTRINHDADAN	NVARCHAR(255),
	-------------------------------------------------------------
	CONSTRAINT PK_CHUONGTRINHMCDAN PRIMARY KEY(MAMC,CHUONGTRINHDADAN),
	CONSTRAINT FK_CHUONGTRINHMCDAN_NGHESY FOREIGN KEY(MAMC) REFERENCES NGHESY(MANGHESY)
);
/*................................
  5. Album ca sỹ (mã ca sỹ, album)
  ................................*/														--	+++++++++++++++++++++++
CREATE TABLE ALBUMCASY (
	MACASY		CHAR(12) NOT NULL,
	ALBUM		NVARCHAR(255),
	-------------------------------------------------------
	CONSTRAINT PK_ALBUMCASY PRIMARY KEY(MACASY,ALBUM),
	CONSTRAINT CHECK_MACASY_ALBUM UNIQUE(MACASY,ALBUM),
	CONSTRAINT FK_ALBUMCASY_NGHESY FOREIGN KEY(MACASY) REFERENCES NGHESY(MANGHESY)
);

/*....................................
  6. Bài hát (mã bài hát, tựa bài hát)
  ....................................*/
CREATE TABLE BAIHAT (
	MABAIHAT		CHAR(8) NOT NULL,
	TUABAIHAT		NVARCHAR(255) NOT NULL,
	------------------------------------------------------
	CONSTRAINT PK_BAIHAT PRIMARY KEY(MABAIHAT),
	CONSTRAINT CHECK_MABAIHAT CHECK(MABAIHAT LIKE ('BH' + '[0-9][0-9][0-9][0-9][0-9][0-9]'))
);

/*.......................................
  7. Thể loại (mã thể loại, tên thể loại)
  .......................................*/
CREATE TABLE THELOAI (
	MATHELOAI		CHAR(5) NOT NULL,
	TENTHELOAI		NVARCHAR(255) NOT NULL UNIQUE,
	---------------------------------------------------
	CONSTRAINT PK_THELOAI PRIMARY KEY(MATHELOAI),
	CONSTRAINT CHECK_MATHELOAI CHECK(MATHELOAI LIKE ('TL' + '[0-9][0-9][0-9]'))
);

/*...................................................
  8. Bài hát thuộc thể loại (mã bài hát, mã thể loại)
  ...................................................*/
CREATE TABLE BAIHATTHUOCTHELOAI (
	MABAIHAT		CHAR(8),
	MATHELOAI		CHAR(5) NOT NULL,
	------------------------
	CONSTRAINT PK_BAIHATTHUOCTHELOAI PRIMARY KEY (MABAIHAT,MATHELOAI),
	CONSTRAINT FK_BAIHATTHUOCTHELOAI_BAIHAT FOREIGN KEY(MABAIHAT) REFERENCES BAIHAT(MABAIHAT),
	CONSTRAINT FK_BAIHATTHUOCTHELOAI_THELOAI FOREIGN KEY(MATHELOAI) REFERENCES THELOAI(MATHELOAI)
);

/*................................................................
  9. Nhạc sỹ sáng tác (Mã nhạc sỹ, mã bài hát, thông tin sáng tác)
  ................................................................*/
CREATE TABLE NHACSYSANGTAC (
	MANHACSY			CHAR(12) NOT NULL,
	MABAIHAT			CHAR(8),
	THONGTINSANGTAC		INT,
	------------------------------------------------------
	CONSTRAINT PK_NHACSYSANGTAC PRIMARY KEY (MANHACSY,MABAIHAT),
	CONSTRAINT FK_NHACSYSANGTAC FOREIGN KEY(MANHACSY) REFERENCES NGHESY(MANGHESY),
	CONSTRAINT CHECK_THONGTINSANGTAC CHECK(THONGTINSANGTAC IN (1,2,3))
);

/*..............................................
  10. Tỉnh thành (mã tỉnh thành, tên tỉnh thành)
  ..............................................*/
CREATE TABLE TINHTHANH (
	MATINHTHANH		CHAR(4) NOT NULL,
	TENTINHTHNAH	NVARCHAR(255) NOT NULL UNIQUE,
	------------------------------------------------------
	CONSTRAINT PK_TINHTHANH PRIMARY KEY (MATINHTHANH),
	CONSTRAINT CHECK_MATINHTHANH CHECK(MATINHTHANH LIKE('TT' + '[0-9][0-9]'))
);

/*....................................................
  11. Nhà sản xuất (mã nhà sản xuất, tên nhà sản xuất)
  ....................................................*/
CREATE TABLE NHASANXUAT (
	MANHASANXUAT	CHAR(6) NOT NULL,
	TENNHASANXUAT	NVARCHAR(255),
	---------------------------------------------
	CONSTRAINT PK_NHASANXUAT PRIMARY KEY(MANHASANXUAT),
	CONSTRAINT CHECK_MANHASANXUAT CHECK(MANHASANXUAT LIKE('NSX' + '[0-9][0-9][0-9]'))
);

/*........................................
  12. Kênh truyền hình (mã kênh, tên kênh)
  ........................................*/
CREATE TABLE KENHTRUYENHINH (
	MAKENH		CHAR(5) NOT NULL,
	TENKENH		NVARCHAR(255) NOT NULL,
	-----------------------------------
	CONSTRAINT PK_KENHTRUYENHINH PRIMARY KEY(MAKENH),
	CONSTRAINT CHECK_MAKENH CHECK(MAKENH LIKE('TH' + '[0-9][0-9][0-9]'))
);

/*........................................
  13. Mùa thi (mã mùa thi, ngày tháng năm bắt đầu, 
  ngày tháng năm kết thúc, giải thưởng, địa điểm
  vòng nhà hát, địa điểm vòng bán kết, địa điểm vòng gala, 
  mã giám đốc âm nhạc, mã giám khảo
  1, mã giám khảo 2, mã giám khảo 3, mã MC)
  ........................................*/
  --ham tu dong tang
  go
Create function gen_mamuathi()
Returns VARCHAR(12)
As
Begin
	Declare @max varchar(10)
	declare @msv varchar(12)
	Select @max = (SELECT top 1 MAMUATHI from MUATHI order by MAMUATHI desc)
	Set @max = right(@max, 4)
	Declare @stt int
	If (@max is null)
		Set @stt = 1
	Else
		Set @stt = convert(int, @max) + 1
		If (@stt < 10)
			set @msv =  'MT000' + CONVERT(VARCHAR(7),@stt)
		Else if (@stt < 100)
			set @msv =  'MT00' + CONVERT(VARCHAR(8),@stt)
		Else if (@stt <1000)
			set @msv =  'MT0' + CONVERT(VARCHAR(9),@stt)
		ELSE
			set @msv =  'MT' + CONVERT(VARCHAR(10),@stt)
		return @msv
End
go		--tao bang
CREATE TABLE MUATHI (
	MAMUATHI			VARCHAR(12) DEFAULT dbo.gen_mamuathi(),
	NGAYBATDAU			DATE,
	NGAYKETTHUC			DATE,
	GIAITHUONG			NVARCHAR(MAX),
	DIADIEMVONGNHAHAT	NVARCHAR(255),
	DIADIEMVONGBANKET	NVARCHAR(255),
	DIADIEMVONGGALA		NVARCHAR(255),
	MAGIAMDOCAMNHAC		CHAR(20),
	MAGIAMKHAO1			CHAR(12),
	MAGIAMKHAO2			CHAR(12),
	MAGIAMKHAO3			CHAR(12),
	MAMC				CHAR(12),
	-----------------------------------------------
	CONSTRAINT PK_MUATHI PRIMARY KEY(MAMUATHI),
	CONSTRAINT CHECK_NGAYBATDAU CHECK(NGAYBATDAU LIKE TRY_CONVERT(DATE,CAST(NGAYBATDAU AS DATE),105)),
	CONSTRAINT CHECK_NGAYKETTHUC CHECK(NGAYKETTHUC LIKE TRY_CONVERT(DATE,CAST(NGAYKETTHUC AS DATE),105)),
	CONSTRAINT CHECK_NGAYKETTHUC_NGAYBATDAU CHECK(NGAYKETTHUC > NGAYBATDAU)
);

/*.......................................................
  14. Giữ bản quyền mùa thi (mã mùa thi, mã nhà sản xuất)
  .......................................................*/
CREATE TABLE GIUBANQUYENMUATHI (
	MAMUATHI		VARCHAR(12),
	MANHASANXUAT	CHAR(6),
	-----------------------
	CONSTRAINT PK_GIUBANQUYENMUATHI PRIMARY KEY(MAMUATHI,MANHASANXUAT),
	CONSTRAINT FK_GIUBANQUYENMUATHI_MUATHI FOREIGN KEY(MAMUATHI) REFERENCES MUATHI(MAMUATHI),
	CONSTRAINT FK_GIUBANQUYENMUATHI_NHASANXUAT FOREIGN KEY(MANHASANXUAT) REFERENCES NHASANXUAT(MANHASANXUAT)
);

/*.......................................................
  15. Phát sóng(mã mùa thi, mã kênh, thông tin phát sóng)
  .......................................................*/
CREATE TABLE PHATSONG (
	MAMUATHI		VARCHAR(12),
	MAKENH			CHAR(5),
	THONGTINPHATSONG INT,
	-------------------------
	CONSTRAINT PK_PHATSONG PRIMARY KEY(MAMUATHI,MAKENH),
	CONSTRAINT CHECK_THONGTINPHATSONG CHECK(THONGTINPHATSONG IN (1,2,3)),
	CONSTRAINT FK_PHATSONG_KENHTRUYENHINH FOREIGN KEY(MAKENH) REFERENCES KENHTRUYENHINH(MAKENH),
	CONSTRAINT FK_PHATSONG_MUATHI FOREIGN KEY (MAMUATHI) REFERENCES MUATHI(MAMUATHI)
);
/*.......................................................
  16. Vòng thi (STT vòng thi, mã mùa thi, tên vòng thi, 
  thời gian bắt đầu, thời gian kết thúc, loại vòng thi)
  .......................................................*/
CREATE TABLE VONGTHI (
	STTVONGTHI			INT IDENTITY(1,1) ,
	MAMUATHI			VARCHAR(12),
	TENVONGTHI			NVARCHAR(255),
	THOIGIANBATDAU		SMALLDATETIME,
	THOIGIANKETTHUC		SMALLDATETIME,
	LOAIVONGTHI			INT,
	-----------------------------
	CONSTRAINT PK_VONGTHI PRIMARY KEY(STTVONGTHI,MAMUATHI),
	--CONSTRAINT CHECK_THOIGIANBATDAU CHECK(THOIGIANBATDAU LIKE cONvert(datetime,THOIGIANBATDAU,105) + ' ' + right(cONvert(varchar(4),THOIGIANBATDAU,108),4)),
	--CONSTRAINT CHECK_THOIGIANKETTHUC CHECK(THOIGIANKETTHUC LIKE cONvert(datetime,THOIGIANKETTHUC,105) +  ' ' + right(cONvert(varchar(4),THOIGIANKETTHUC,108),4)),
	CONSTRAINT CHECK_THOIGIANKETTHUC_THOIGIANBATDAU CHECK(THOIGIANKETTHUC > THOIGIANBATDAU),
	CONSTRAINT FK_VONGTHI_MUATHI FOREIGN KEY(MAMUATHI) REFERENCES MUATHI(MAMUATHI),
	CONSTRAINT CHECK_LOAIVONGTHI CHECK(LOAIVONGTHI IN(1,2,3,4))
);
--------------------------------------------------------------------------------------------------
/*...............................................................................
  17. Thí sinh tham gia vòng thi (STT vòng thi, mã mùa thi, mã thí sinh, kết quả)
  ...............................................................................*/
CREATE TABLE THISINHTHAMGIAVONGTHI (
	STTVONGTHI			INT,
	MAMUATHI			VARCHAR(12),
	MATHISINH			CHAR(12),
	KETQUA				INT DEFAULT -1,
	-----------------------------------
	CONSTRAINT PK_THISINHTHAMGIAVONGTHI PRIMARY KEY(STTVONGTHI,MAMUATHI,MATHISINH),
	CONSTRAINT CHECK_KETQUA CHECK(KETQUA IN(-1,0,1,2,3)),
	CONSTRAINT FK_THISINHTHAMGIAVONGTHI_MUATHI FOREIGN KEY(MAMUATHI) REFERENCES MUATHI(MAMUATHI),
	CONSTRAINT FK_THISINHTHAMGIAVONGTHI_THISINH FOREIGN KEY(MATHISINH) REFERENCES THISINH(MATHISINH),
	CONSTRAINT FK_THISINHTHAMGIAVONGTHI_VONGTHI FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGTHI(STTVONGTHI,MAMUATHI) 
);
/*......................................................................
  18. Vòng thử giọng (STT vòng thi, mã mùa thi, mã tỉnh thành, địa điểm)
  .......................................................................*/
CREATE TABLE VONGTHUGIONG (
	STTVONGTHI			INT,
	MAMUATHI			VARCHAR(12),
	MATINHTHANH			CHAR(4),
	DIADIEM				NVARCHAR(255),
	---------------------------------
	CONSTRAINT PK_VONGTHUGIONG PRIMARY KEY(STTVONGTHI,MAMUATHI),
	CONSTRAINT FK_VONGTHUGIONG_TINHTHANH FOREIGN KEY(MATINHTHANH) REFERENCES TINHTHANH(MATINHTHANH),
	CONSTRAINT FK_VONGTHUGIONG_VONGTHI FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGTHI(STTVONGTHI,MAMUATHI) 
);
/*..........................................................................................
  19. Thí sinh tham gia vòng thử giọng (STT vòng thi, mã mùa thi, mã thí sinh, GK1, GK2, GK3)
  .........................................................................................*/
CREATE TABLE THISINHTHAMGIAVONGTHUGIONG (
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	MATHISINH		CHAR(12),
	GK1				INT,
	GK2				INT,
	GK3				INT,
	-----------------------
	CONSTRAINT PK_THISINHTHAMGIAVONGTHUGIONG PRIMARY KEY(STTVONGTHI,MAMUATHI,MATHISINH),
	CONSTRAINT CHECK_GK1 CHECK(GK1 IN(0,1)),
	CONSTRAINT CHECK_GK2 CHECK(GK2 IN(0,1)),
	CONSTRAINT CHECK_GK3 CHECK(GK3 IN(0,1)),
	CONSTRAINT FK_THISINHTHAMGIAVONGTHUGIONG_VONGTHUGIONG FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGTHUGIONG(STTVONGTHI,MAMUATHI),
	CONSTRAINT FK_THISINHTHAMGIAVONGTHUGIONG_THISINH FOREIGN KEY(MATHISINH) REFERENCES THISINH(MATHISINH)
);

/*.......................................................................................
  20. Thí sinh hát tại vòng thử giọng (STT vòng thi, mã mùa thi, mã thí sinh, mã bài hát)
  .......................................................................................*/
CREATE TABLE THISINHHATTAIVONGTHUGIONG (
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	MATHISINH		CHAR(12),
	MABAIHAT		CHAR(8),
	------------------------
	CONSTRAINT PK_THISINHHATTAIVONGTHUGIONG PRIMARY KEY(STTVONGTHI,MAMUATHI,MATHISINH,MABAIHAT),
	CONSTRAINT FK_THISINHHATTAIVONGTHUGIONG_THISINH FOREIGN KEY(MATHISINH) REFERENCES THISINH(MATHISINH),
	CONSTRAINT FK_THISINHHATTAIVONGTHUGIONG_BAIHAT FOREIGN KEY(MABAIHAT) REFERENCES BAIHAT(MABAIHAT),
	CONSTRAINT FK_THISINHHATTAIVONGTHUGIONG_VONGTHUGIONH FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGTHUGIONG(STTVONGTHI,MAMUATHI)
);

/*........................................................
  21. Vòng nhà hát (STT vòng thi, mã mùa thi, HatNhomFlag)
  ........................................................*/
CREATE TABLE VONGNHAHAT (
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	HATNHOMFLAG		INT,
	---------------------
	CONSTRAINT PK_VONGBAIHAT PRIMARY KEY(STTVONGTHI,MAMUATHI),
	CONSTRAINT FK_VONGBAIHAT_VONGTHI FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGTHI(STTVONGTHI,MAMUATHI),
	CONSTRAINT CHECK_HATNHOM CHECK(HATNHOMFLAG IN(0,1))
);
/*.......................................................................................
  22. Thí sinh hát tại vòng nhà hát (STT vòng thi, mã mùa thi, mã thí sinh, mã bài hát)
  ....................................................................................*/
CREATE TABLE THISINHHATTAIVONGNHAHAT (
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	MATHISINH		CHAR(12),
	MABAIHAT		CHAR(8),
	----------------
	CONSTRAINT PK_THISINHHATTAIVONGNHAHAT PRIMARY KEY(STTVONGTHI,MAMUATHI,MATHISINH,MABAIHAT),
	CONSTRAINT FK_THISINHHATTAIVONGNHAHAT_THISINH FOREIGN KEY(MATHISINH)REFERENCES THISINH(MATHISINH),
	CONSTRAINT FK_THISINHHATTAIVONGNHAHAT_VONGBAIHAT FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGNHAHAT(STTVONGTHI, MAMUATHI),
	CONSTRAINT FK_THISINHHATTAIVONGNHAHAT_BAIHAT FOREIGN KEY(MABAIHAT) REFERENCES BAIHAT(MABAIHAT)
);
/*.......................................................................................
  23. Nhóm ca (mã nhóm, tên nhóm, mã thí sinh 1, mã thí sinh 2, mã thí sinh 3, mã thí sinh 4)
  ....................................................................................*/
CREATE TABLE NHOMCA (
	MANHOM			CHAR(8) NOT NULL,
	TENNHOM			NVARCHAR(255),
	MATHISINH1		CHAR(12) NOT NULL UNIQUE,
	MATHISINH2		CHAR(12) NOT NULL UNIQUE,
	MATHISINH3		CHAR(12) NOT NULL UNIQUE,
	MATHISINH4		CHAR(12) NOT NULL UNIQUE,
	-----------------------------------------
	CONSTRAINT PK_NHOMCA PRIMARY KEY(MANHOM),
	CONSTRAINT CHECK_MANHOM CHECK(MANHOM LIKE('NC' + '[0-9][0-9][0-9][0-9][0-9][0-9]'))
);


/*.......................................................................
  24. Nhóm ca hát bài hát (mã nhóm, mã bài hát, STT vòng thi, mã mùa thi)
  ........................................................................*/
CREATE TABLE NHOMCAHATBAIHAT (
	MANHOM			CHAR(8),
	MABAIHAT		CHAR(8),
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	------------------------------
	CONSTRAINT PK_NHOMCABAIHAT PRIMARY KEY(MANHOM,MABAIHAT),
	CONSTRAINT FK_NHOMCAHATBAIHAT_VONGNHAHAT FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGNHAHAT(STTVONGTHI,MAMUATHI),
	CONSTRAINT FK_NHOMCAHATBAIHAT_NHOMCA FOREIGN KEY(MANHOM) REFERENCES NHOMCA(MANHOM),
	CONSTRAINT FK_NHOMCAHATBAIHAT_BAIHAT FOREIGN KEY(MABAIHAT) REFERENCES BAIHAT(MABAIHAT)
);
/*.......................................................................
  25. Vòng bán kết (STT vòng thi, mã mùa thi, Nam_Nữ)
  ........................................................................*/
CREATE TABLE VONGBANKET (
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	NAM_NU			INT DEFAULT -1,
	--------------------------------
	CONSTRAINT PK_VONGBANKET PRIMARY KEY(STTVONGTHI,MAMUATHI),
	CONSTRAINT CHECK_NAM_NU CHECK(NAM_NU IN(-1,0,1)),
	CONSTRAINT FK_VONGBANKET_VONGTHI FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGTHI(STTVONGTHI,MAMUATHI)
);
/*...................................................
  26. Thí sinh tham gia vòng bán kết (STT vòng thi, mã mùa thi, 
  mã thí sinh, MSBC, tổng số tin nhắn)
  ...................................................*/
CREATE TABLE THISINHTHAMGIAVONGBANKET (
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	MATHISINH		CHAR(12),
	MSBC			CHAR(20),
	TONGSOTINNHAN	INT,
	--------------------
	CONSTRAINT PK_THISINHTHAMGIAVONGBANKET PRIMARY KEY(STTVONGTHI,MAMUATHI,MATHISINH),
	CONSTRAINT FK_THISINHTHAMGIAVONGBANKET_THISINH FOREIGN KEY(MATHISINH) REFERENCES THISINH(MATHISINH), 
);
/*....................................................................................
  27. Thí sinh hát tại vòng bán kết (mã thí sinh, mã bài hát, STT vòng thi, mã mùa thi)                            ++++++++++++++++++
  .....................................................................................*/	
CREATE TABLE THISINHHATTAIVONGBANKET (
	MATHISINH		CHAR(12),
	MABAIHAT		CHAR(8),
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	--------------------------
	CONSTRAINT PK_THISINHHATTAIVONGBANKET PRIMARY KEY(MATHISINH,MABAIHAT),
	CONSTRAINT MABAIHAT_STTVONGTHI_MAMUATHI UNIQUE (MABAIHAT,STTVONGTHI,MAMUATHI),
	CONSTRAINT FK_THISINHHATTAIVONGBANKET_VONGBANKET FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGBANKET(STTVONGTHI,MAMUATHI),
);

/*....................................................................................
  28. Vòng gala (STT vòng thi, mã mùa thi, chủ đề, mã người hướng dẫn, HatDoiFlag
  .....................................................................................*/	
CREATE TABLE VONGGALA (
	STTVONGTHI			INT,
	MAMUATHI			VARCHAR(12),
	CHUDE				NVARCHAR(255) NOT NULL UNIQUE,
	MANGUOIHUONGDAN		CHAR(12),
	HATDOIFLAG			INT,
	------------------------------
	CONSTRAINT PK_VONGGALA PRIMARY KEY(STTVONGTHI,MAMUATHI),
	CONSTRAINT FK_VONGGALA_NGHESY FOREIGN KEY(MANGUOIHUONGDAN) REFERENCES NGHESY(MANGHESY),
	CONSTRAINT CHECK_HATDOIFLAG CHECK(HATDOIFLAG IN(0,1))
);

/*....................................................................................
  29. Thí sinh tham gia vòng gala (STT vòng thi, mã mùa thi, mã thí sinh, MSBC, tổng số tin nhắn)
  .....................................................................................*/	
CREATE TABLE THISINHTHAMGIAVONGGALA (
	STTVONGTHI			INT,
	MAMUATHI			VARCHAR(12),
	MATHISINH			CHAR(12),
	MSBC				CHAR(20),
	TONGSOTINNHAN		INT,
	------------------------------
	CONSTRAINT PK_THISINHTHAMGIAVONGGALA PRIMARY KEY(STTVONGTHI,MAMUATHI,MATHISINH),
	CONSTRAINT FK_THISINHTHAMGIAVONGGALA_THISINH FOREIGN KEY(MATHISINH) REFERENCES THISINH(MATHISINH),
	CONSTRAINT CHECK_TONGSOTINNHAN_GALA CHECK(TONGSOTINNHAN >= 0),
	CONSTRAINT FK_THISINHTHAMGIAVONGGALA_VONGGALA FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGGALA(STTVONGTHI,MAMUATHI)
);	
/*....................................................................................
  30. Thí sinh hát tại vòng gala (mã thí sinh, mã bài hát, STT vòng thi, mã mùa thi)
  .....................................................................................*/	
CREATE TABLE THISINHHATTAIVONGGALA (
	MATHISINH		CHAR(12),
	MABAIHAT		CHAR(8),
	STTVONGTHI		INT,
	MAMUATHI		VARCHAR(12),
	--------------------------
	CONSTRAINT PK_THISINHHATTAIVONGGALA PRIMARY KEY(MATHISINH,MABAIHAT),
	CONSTRAINT FK_THISINHHATTAIVONGGALA_VONGGALA FOREIGN KEY(STTVONGTHI,MAMUATHI) REFERENCES VONGGALA(STTVONGTHI,MAMUATHI)
);

-- + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + + --
--II. Tạo Index (1đ)---------------------------------------------------------------------------------------------------------------  TẠO INDEX
--Người dùng cơ sở dữ liệu thường hay truy vấn những thông tin như sau:
--a. Thông tin các vòng thi dựa trên tên của vòng thi. (Ví dụ: gala 1, gala 2,…
CREATE INDEX GETBASEDON_TENVONGTHI ON VONGTHI(TENVONGTHI)
--b. Thông tin thí sinh dựa vào CMND.
ALTER TABLE THISINH 
ADD CMND CHAR(20)
CREATE INDEX GETBASEDON_CMND ON THISINH(CMND)
--c. Thông tin mùa giải dựa vào ngày tháng năm bắt đầu.
CREATE INDEX GETBASEDON_NGAYBATDAU ON MUATHI(NGAYBATDAU)
--NOTE
--MANGUOI(12)     MANHASANXUAT(6)	MAMUATHI(50)   MABAIHAT(8)    MATHELOAI(5)   MAKENH(5)  MATINHTHANH(4) MANHOM(8)

/*#############################################################                                        PHẦN 2: STORE PROCEDURE, FUNCTION, TRIGGER (2.5đ)
--#############################################################*/
--I. Store Procedure/Function (1.25đ)                                                  -- PROCEDURE / FUNCTION
--1. Viết hai hàm dùng để tìm khoảng số thứ tự của một loại vòng thi nào đó			--FUNTION
--(vòng thử giọng, vòng nhà  hát, vòng bán kết, vòng gala) trong một mùa giải.
--a. Hàm MinSTTVongThi để tìm số thứ tự nhỏ nhất của một loại vòng thi. (0.25đ) 
GO
CREATE FUNCTION MinSTTVongThi(@MAMUAGIAI CHAR(50), @LOAIVONGTHI INT)
RETURNS INT
AS
	BEGIN
		DECLARE	@MIN INT
		IF EXISTS (SELECT MAMUATHI, LOAIVONGTHI FROM VONGTHI WHERE MAMUATHI = @MAMUAGIAI AND LOAIVONGTHI = @LOAIVONGTHI)
			BEGIN
				SET @MIN = (SELECT MIN(STTVONGTHI) FROM VONGTHI WHERE MAMUATHI = @MAMUAGIAI)
			END
		ELSE
			SET @MIN = -1
	RETURN @MIN
END
--b. Hàm MaxSTTVongThi để tìm số thứ tự lớn nhất của một loại vòng thi. (0.5đ)
GO
CREATE FUNCTION MaxSTTVongThi(@MAMUAGIAI CHAR(50), @LOAIVONGTHI INT)
RETURNS INT
AS
	BEGIN
		DECLARE	@MAX INT
		IF EXISTS (SELECT MAMUATHI, LOAIVONGTHI FROM VONGTHI WHERE MAMUATHI = @MAMUAGIAI and LOAIVONGTHI = @LOAIVONGTHI)
			BEGIN
				SET @MAX = (SELECT MAX(STTVONGTHI) FROM VONGTHI WHERE MAMUATHI = @MAMUAGIAI)
			END
		ELSE
			SET @MAX = -1
	RETURN @MAX
END
GO
--2. Viết thủ tục CapNhatKetQuaThuGiong dể cập nhật kết quả của thí sinh tại vòng thử giọng. (0.5đ)           -------------------PROCEDURE
CREATE PROCEDURE CapNhatKetQuaThuGiong(@STTVONGTHI INT ,@MAMUAGIAI CHAR(50), @MATHISINH CHAR(12))
AS
BEGIN
	DECLARE @RESULT int
	IF EXISTS (SELECT STTVONGTHI, MAMUATHI, MATHISINH FROM THISINHTHAMGIAVONGTHUGIONG 
		WHERE MAMUATHI = @MAMUAGIAI AND STTVONGTHI = @STTVONGTHI AND MATHISINH = @MATHISINH)
		BEGIN
			DECLARE @NUM INT
			SET @NUM = 0
			DECLARE @BGK1 INT
			DECLARE @BGK2 INT
			DECLARE @BGK3 INT
			SET @BGK1 = (SELECT GK1 FROM THISINHTHAMGIAVONGTHUGIONG WHERE MAMUATHI = @MAMUAGIAI AND STTVONGTHI = @STTVONGTHI AND MATHISINH = @MATHISINH)
			SET @BGK2 = (SELECT GK2 FROM THISINHTHAMGIAVONGTHUGIONG WHERE MAMUATHI = @MAMUAGIAI AND STTVONGTHI = @STTVONGTHI AND MATHISINH = @MATHISINH)
			SET @BGK3 = (SELECT GK3 FROM THISINHTHAMGIAVONGTHUGIONG WHERE MAMUATHI = @MAMUAGIAI AND STTVONGTHI = @STTVONGTHI AND MATHISINH = @MATHISINH)
			SET @NUM = @BGK1 + @BGK2 + @BGK3
			IF @NUM >= 2
				SET @RESULT = 1
			ELSE
				SET @RESULT = 0	
		END
	ELSE
		SET @RESULT = -1
	RETURN @RESULT
END
GO

--HH.Trigger (1.25đ)                                                                           ---------TRIGGER
--1. Viết trigger kiểm tra thông tin hợp lệ của một thí sinh khi đăng ký tham gia một mùa thi:
--a. Tuổi từ 15 tới 30 (tính từ ngày sinh tới ngày bắt đầu mùa thi) khi insert, update thông tin thí sinh. (0.25đ)
CREATE TRIGGER INS_NGAYSINH ON NGUOI
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @NGAYSINH DATETIME
	SELECT @NGAYSINH = NGAYSINH FROM inserted WHERE ID LIKE 'TS%'
	IF (YEAR(getdate()) - YEAR(@NGAYSINH) <= 15 or YEAR(getdate()) - YEAR(@NGAYSINH) >= 30)
		BEGIN
			print N'ĐỘ TUỔI CỦA BẠN KHÔNG PHÙ HỢP'
			ROLLBACK TRANSACTION
		END
END
GO
--b. Chưa từng lọt tới vòng thi gala trong tất cả mùa giải trước đó. (0.5đ) ------------------------------------------------------
CREATE TRIGGER INS_NOTFINAL ON THISINHTHAMGIAVONGTHI
FOR INSERT ,UPDATE
AS BEGIN
	DECLARE @MATHISINH CHAR(12)
	SET @MATHISINH = (SELECT MATHISINH FROM inserted )
	IF ( SELECT COUNT(*) FROM THISINHTHAMGIAVONGGALA WHERE MATHISINH = @MATHISINH) >= 1 
	print N'BẠN KHÔNG THỂ THAM GIA MUA THI NÀY'
	ROLLBACK TRANSACTION
END
GO
--2. Viết trigger kiểm tra thông tin mã số bình chọn cho thí sinh trong các vòng bán kết và gala phải 
--	không được trùng lắp trong một vòng thi. (0.5đ)
CREATE TRIGGER INS_TSTHAMGIAVBK ON THISINHTHAMGIAVONGBANKET
FOR INSERT,UPDATE 
AS BEGIN
	DECLARE @MSBC CHAR(12)
	SET @MSBC = (SELECT MSBC FROM INSERTED)
	DECLARE @STTVONGTHI INT
	SET @STTVONGTHI = (SELECT STTVONGTHI FROM INSERTED)
	IF (SELECT COUNT(*) FROM THISINHTHAMGIAVONGBANKET WHERE STTVONGTHI = @STTVONGTHI AND MSBC = @MSBC) > =1
		PRINT N'MÃ SỐ BÌNH CHỌN KHÔNG HỢP LỆ'
		ROLLBACK TRANSACTION
END
GO
--PHẦN 3: THAO TÁC CƠ SỞ DỮ LIỆU (2.5đ)
----------------------------------------------------
--I. Insert (0.75đ)
--Thực hiện việc nhập dữ liệu cho các bảng trong cơ sở dữ liệu.
--Yêu cầu: Dữ liệu trong các bảng phải có nghĩa, và mỗi bảng có tối thiểu 4 hàng
--INSERT INTO NGUOI(ID,CMND,TEN,GIOITINH,NGAYSINH,NOISINH) VALUES
--('TS'),
-- BẢNG 1 -- NGUOI
INSERT INTO NGUOI(ID,CMND,TEN,GIOITINH,NGAYSINH,NOISINH) VALUES
('TS2001000001','215557097',N'NGUYỄN VĂN AN',0,'18/11/2001',N'QUẬN 7 SÀI GÒN'),
('TS1997000002','217894528',N'NGUYỄN VINH TIẾNG',0,'12/4/1997',N'PHÙ CÁT BÌNH ĐỊNH'),
('TS2000000003','317854215',N'NGUYỄN THANH NHÃ',1,'11/6/2000',N'QUẬN 1 SÀI GÒN'),
('TS1999000004','364421579',N'NGUYỄN THANH NGÂN',1,'23/4/1999',N'THẮNG TAM VŨNG TÀU'),
('NS000001','264584789',N'TRẦN VĂN LONG',0,'23/9/1996',N'QUẬN 3 SÀI GÒN'),
('NS000002','364489657',N'NGUYỄN VĂN TUẤN',0,'12/3/1995',N'AN LÃO BÌNH ĐỊNH'),
('NS000003','148756247',N'LÊ THỊ KÌ DUYÊN',1,'23/9/1992',N'NINH SƠN NINH THUẬN'),
('NS000004','264584789',N'VÕ DUY TRỌNG',0,'11/5/1999',N'YÊN PHONG BẮC NINH'),
('NS000005','986547852',N'NGUYỄN THẮNG',0,'19/9/2000',N'BẮC YÊN SƠN LA'),
('NS000006','215478625',N'NGUYỄN THỊ THU LỢI',1,'30/1/1993',N'NGHI LỘC NGHỆ AN'),
('NS000007','365482547',N'TRƯƠNG THANH DIỆU',1,'25/2/1995',N'BÁC ÁI NINH THUẬN'),
('NS000008','369852146',N'NGUYỄN VĂN HẬU',0,'7/10/1997',N'PLEIKU GIA LAI');

-- BẢNG 2 --THISINH
INSERT INTO THISINH(MATHISINH,DIACHI,DIENTHOAI,GIOITHIEU,CMND) VALUES
('TS2001000001',N'TÂN PHONG QUẬN 7 THÀNH PHỐ HỒ CHÍ MINH','0353571254',N'THÍ SINH CÓ NHIỀU NĂM ĐI HÁT','215557097'),
('TS1997000002',N'TÂN HƯNG QUẬN 7 THÀNH PHỐ HỒ CHÍ MINH','0356975169',N'THÍ SINH CHƯA TỪNG THAM GIA CUỘC THI VỀ NGHỆ THUẬT','217894528'),
('TS2000000003',N'PHƯỜNG THẮNG TAM THÀNH PHỐ VŨNG TÀU','0976845246',N'CÓ GIỌNG HÁT KHỎE','317854215'),
('TS1999000004',N'CÁT THẮNG PHÙ CÁT BÌNH ĐỊNH','0346879564',N'ĐƯỢC NHIỀU NGƯỜI YÊU THÍCH','364421579');

-- BẢNG 3 --NGHESY
INSERT INTO NGHESY(MANGHESY,NGHEDANH,THANHTICH,MCFLAG,CSFLAG,NSFLAG) VALUES
('NS000001',N'VĂN LONG','QUÁN QUÂN GIỌNG HÁT VIỆT 2019',1,0,0),
('NS000002',N'VĂN TUẤN','Á QUÂN GIỌNG HÁT VIỆT 2019',1,0,0),
('NS000003',N'DUYÊN KỲ','MV NHIỀU VIEW NHẤT NĂM 2019',0,1,0),
('NS000004',N'TỰ TRỌNG','MV NHIỀU LIKE NHẤT NĂM 2019',0,1,0),
('NS000005',N'VĂN THẮNG','GIỌNG HÁT VÀNG 2019',1,1,0),
('NS000006',N'NHÃ LỢI','TỐT NGHIỆP HỌC VIỆN ÂM NHẠC LOẠI GIỎI',0,0,1),
('NS000007',N'THANH DIỆU','TỐT NGHIỆP HỌC VIỆN ÂM NHẠC LOẠI GIỎI',0,0,1),
('NS000008',N'PHÚC HẬU','QUÁN QUÂN GIỌNG HÁT VIỆT 2018',1,1,1);

-- BẢNG 4 --CHUONGTRINHMCDAN
INSERT INTO CHUONGTRINHMCDAN(MAMC,CHUONGTRINHDADAN) VALUES
('NS000001',N'RAP VIỆT'),
('NS000002',N'KING OF RAP'),
('NS000005',N'CUỐI TUẦN VUI VẺ'),
('NS000008',N'TUYỆT ĐỈNH GIÁC QUAN');

-- BẢNG 5 --ALBUMCASY
INSERT INTO ALBUMCASY(MACASY,ALBUM) VALUES
('NS000003',N'ALBUM LẠC TRÔI'),
('NS000004',N'ALBUM CÓ CHẮC YÊU LÀ ĐÂY'),
('NS000005',N'ALBUM CÓ LẼ'),
('NS000005',N'ALBUM ĐƯỜNG SONG SONG'),
('NS000008',N'ĐOM ĐÓM ALBUM');

--BẢNG 6 --BAIHAT
INSERT INTO BAIHAT(MABAIHAT,TUABAIHAT) VALUES
('BH000001',N'CÓ CHẮC YÊU LÀ ĐÂY'),
('BH000002',N'ÂM THẦM BÊN EM'),
('BH000003',N'ĐOM ĐÓM'),
('BH000004',N'CÓ LẼ'),
('BH000005',N'EM CỦA NGÀY HÔM QUA');

-- BẢNG 7 --THELOAI
INSERT INTO THELOAI(MATHELOAI,TENTHELOAI) VALUES
('TL001',N'TRỮ TÌNH'),
('TL002',N'RAP'),
('TL003',N'BOLERO'),
('TL004',N'REMIX'),
('TL005',N'DÂN CA'),
('TL006',N'HIPHOP'),
('TL007',N'ROCK');

-- BẢNG 8 --BAIHATTHUOCTHELOAI
INSERT INTO BAIHATTHUOCTHELOAI(MABAIHAT,MATHELOAI) VALUES
('BH000001','TL002'),
('BH000002','TL001'),
('BH000003','TL004'),
('BH000004','TL002');

-- BẢNG 9 --NHACSYSANGTAC
INSERT INTO  NHACSYSANGTAC(MANHACSY,MABAIHAT,THONGTINSANGTAC) VALUES
('NS000006','BH000001',1),
('NS000007','BH000002',2),
('NS000008','BH000003',3),
('NS000006','BH000004',3);

-- BẢNG 10 --TINHTHANH
INSERT INTO TINHTHANH(MATINHTHANH,TENTINHTHNAH) VALUES
('TT01',N'NGHỆ AN'),
('TT02',N'THANH HÓA'),
('TT03',N'BÌNH ĐỊNH'),
('TT04',N'HỒ CHÍ MINH'),
('TT05',N'NHÀ NỘI'),
('TT06',N'QUẢNG NGÃI'),
('TT07',N'GIA LAI');

-- BẢNG 11 --NHASANXUAT
INSERT INTO NHASANXUAT(MANHASANXUAT,TENNHASANXUAT) VALUES
('NSX001',N'KOKOMI'),
('NSX002',N'CLEAR MEN'),
('NSX003',N'ROMANO'),
('NSX004',N'CASTROL'),
('NSX005',N'STING');

-- BẢNG 12 --KENHTRUYENHINH
INSERT INTO KENHTRUYENHINH(MAKENH,TENKENH) VALUES
('TH001',N'TRUYỀN HÌNH VĨNH LONG'),
('TH002',N'TRUYỀN HÌNH THÀNH PHỐ HỒ CHÍ MINH'),
('TH003',N'TRUYỀN HÌNH HÀ NỘI'),
('TH004',N'HTV3'),
('TH005',N'CARTOON NETWORK');


-- BẢNG 13 --MUATHI
INSERT INTO MUATHI(NGAYBATDAU,NGAYKETTHUC,GIAITHUONG,DIADIEMVONGNHAHAT,DIADIEMVONGBANKET,DIADIEMVONGGALA,
					MAGIAMDOCAMNHAC,MAGIAMKHAO1,MAGIAMKHAO2,MAGIAMKHAO3,MAMC) VALUES
('1/1/2019','2/2/2019',N'100 TRIỆU',N'QUẬN 7',N'QUẬN 1',N'QUẬN THỦ ĐỨC','GDAM01','GK001','GK002','GK003','NS000001');
INSERT INTO MUATHI(NGAYBATDAU,NGAYKETTHUC,GIAITHUONG,DIADIEMVONGNHAHAT,DIADIEMVONGBANKET,DIADIEMVONGGALA,
					MAGIAMDOCAMNHAC,MAGIAMKHAO1,MAGIAMKHAO2,MAGIAMKHAO3,MAMC) VALUES
('3/2/2019','4/3/2019',N'200 TRIỆU',N'QUẬN 7',N'QUẬN 1',N'QUẬN THỦ ĐỨC','GDAM04','GK005','GK002','GK003','NS000002');
INSERT INTO MUATHI(NGAYBATDAU,NGAYKETTHUC,GIAITHUONG,DIADIEMVONGNHAHAT,DIADIEMVONGBANKET,DIADIEMVONGGALA,
					MAGIAMDOCAMNHAC,MAGIAMKHAO1,MAGIAMKHAO2,MAGIAMKHAO3,MAMC) VALUES
('30/3/2019','3/5/2019',N'500 TRIỆU',N'QUẬN 7',N'QUẬN 1',N'QUẬN THỦ ĐỨC','GDAM01','GK005','GK002','GK003','NS000002');
INSERT INTO MUATHI(NGAYBATDAU,NGAYKETTHUC,GIAITHUONG,DIADIEMVONGNHAHAT,DIADIEMVONGBANKET,DIADIEMVONGGALA,
					MAGIAMDOCAMNHAC,MAGIAMKHAO1,MAGIAMKHAO2,MAGIAMKHAO3,MAMC) VALUES
('1/7/2019','2/9/2019',N'1 TỈ',N'QUẬN 7',N'QUẬN 1',N'QUẬN 7','GDAM01','GK001','GK002','GK003','NS000001');

-- BẢNG 14 --GIUBANQUYENMUATHI
INSERT INTO GIUBANQUYENMUATHI(MAMUATHI,MANHASANXUAT) VALUES
('MT0001','NSX001'),
('MT0002','NSX004'),
('MT0003','NSX004'),
('MT0004','NSX002');

-- BẢNG 15 --PHATSONG
INSERT INTO PHATSONG(MAMUATHI,MAKENH,THONGTINPHATSONG) VALUES
('MT0001','TH001',1),
('MT0002','TH003',2),
('MT0003','TH002',3),
('MT0004','TH001',2);

-- BẢNG 16 --VONGTHI
INSERT INTO VONGTHI(MAMUATHI,TENVONGTHI,THOIGIANBATDAU,THOIGIANKETTHUC,LOAIVONGTHI) VALUES
('MT0001',N'VÒNG THỬ GIỌNG','1-1-2019 02:00','2-2-2020 02:00',1),
('MT0001',N'VÒNG NHÀ HÁT','3/1/2019 02:00','4/1/2019 02:00',2),
('MT0001',N'VÒNG BÁN KẾT','5/1/2019 02:00','6/1/2019 02:00',3),
('MT0001',N'VÒNG GALA','7/1/2019 02:00','10/1/2019 02:00',4),
('MT0002',N'VÒNG THỬ GIỌNG','1/1/2019 02:00','2/1/2019 02:00',1),
('MT0002',N'VÒNG NHÀ HÁT','3/1/2019 02:00','4/1/2019 02:00',2),
('MT0002',N'VÒNG BÁN KẾT','5/1/2019 02:00','6/1/2019 02:00',3),
('MT0002',N'VÒNG GALA','7/1/2019 02:00','10/1/2019 02:00',4),
('MT0003',N'VÒNG THỬ GIỌNG','1/1/2019 02:00','2/1/2019 02:00',1),
('MT0003',N'VÒNG NHÀ HÁT','3/1/2019 02:00','4/1/2019 02:00',2),
('MT0003',N'VÒNG BÁN KẾT','5/1/2019 02:00','6/1/2019 02:00',3),
('MT0003',N'VÒNG GALA','7/1/2019 02:00','10/1/2019 02:00',4),
('MT0004',N'VÒNG THỬ GIỌNG','1/1/2019 02:00','2/1/2019 02:00',1),
('MT0004',N'VÒNG NHÀ HÁT','3/1/2019 02:00','4/1/2019 02:00',2),
('MT0004',N'VÒNG BÁN KẾT','5/1/2019 02:00','6/1/2019 02:00',3),
('MT0004',N'VÒNG GALA','7/1/2019 02:00','10/1/2019 02:00',4);

-- BẢNG 17 --THISINHTHAMGIAVONGTHI
INSERT INTO THISINHTHAMGIAVONGTHI(STTVONGTHI,MAMUATHI,MATHISINH,KETQUA) VALUES
(1,'MT0001','TS2001000001',1),
(2,'MT0001','TS2001000001',1),
(3,'MT0001','TS2001000001',1),
(4,'MT0001','TS2001000001',1),
(1,'MT0001','TS1997000002',1),
(2,'MT0001','TS1997000002',1),
(3,'MT0001','TS1997000002',1),
(4,'MT0001','TS1997000002',1),
(1,'MT0001','TS2000000003',1),
(2,'MT0001','TS2000000003',1),
(3,'MT0001','TS2000000003',1),
(4,'MT0001','TS2000000003',1),
(1,'MT0001','TS1999000004',1),
(2,'MT0001','TS1999000004',1),
(3,'MT0001','TS1999000004',1),
(4,'MT0001','TS1999000004',1);

-- BẢNG 18 --VONGTHUGIONG
INSERT INTO VONGTHUGIONG(STTVONGTHI,MAMUATHI,MATINHTHANH,DIADIEM) VALUES
(1,'MT0001','TT01',N'ALHAMBRA ĐƯỜNG NGUYỄN CƯ TRINH'),
(5,'MT0002','TT01',N'ASAM ĐƯỜNG CÔNG TRÍ'),
(9,'MT0003','TT01',N'CATHAY ĐƯỜNG NGUYỄN THIỆP'),
(13,'MT0004','TT01',N'ĐẠI NAM 79 TRẦN HƯNG ĐẠO');

-- BẢNG 19 --THISINHTHAMGIAVONGTHUGIONG
INSERT INTO THISINHTHAMGIAVONGTHUGIONG(STTVONGTHI,MAMUATHI,MATHISINH,GK1,GK2,GK3) VALUES
(1,'MT0001','TS2001000001',1,1,0),
(1,'MT0001','TS1997000002',1,1,0),
(1,'MT0001','TS2000000003',0,1,1),
(1,'MT0001','TS1999000004',1,1,1);


-- BẢNG 20 --THISINHHATTAIVONGTHUGIONG
INSERT INTO THISINHHATTAIVONGTHUGIONG(STTVONGTHI,MAMUATHI,MATHISINH,MABAIHAT) VALUES
(1,'MT0001','TS2001000001','BH000001'),
(1,'MT0001','TS1997000002','BH000002'),
(1,'MT0001','TS2000000003','BH000003'),
(1,'MT0001','TS1999000004','BH000004');

-- BẢNG 21 --VONGNHAHAT
INSERT INTO VONGNHAHAT(STTVONGTHI,MAMUATHI,HATNHOMFLAG) VALUES
(2,'MT0001',0),
(6,'MT0002',0),
(10,'MT0003',0),
(14,'MT0004',0);

-- BẢNG 22 --THISINHHATTAIVONGNHAHAT
INSERT INTO THISINHHATTAIVONGNHAHAT(STTVONGTHI,MAMUATHI,MATHISINH,MABAIHAT) VALUES
(2,'MT0001','TS2001000001','BH000005'),
(2,'MT0001','TS1997000002','BH000002'),
(2,'MT0001','TS2000000003','BH000003'),
(2,'MT0001','TS1999000004','BH000001');

-- BẢNG 23 --NHOMCA
INSERT INTO NHOMCA(MANHOM,TENNHOM,MATHISINH1,MATHISINH2,MATHISINH3,MATHISINH4) VALUES
('NC201901',N'SƠN CA','TS1','TS2','TS3','TS4'),
('NC201902',N'HỌA MI','TS5','TS6','TS7','TS8'),
('NC201903',N'THẤT SƠN','TS9','TS10','TS11','TS12'),
('NC201904',N'VÔ ĐỊCH','TS13','TS14','TS15','TS16');

-- BẢNG 24 --NHOMCAHATBAIHAT
INSERT INTO NHOMCAHATBAIHAT(MANHOM,MABAIHAT,STTVONGTHI,MAMUATHI) VALUES
('NC201901','BH000005',2,'MT0001'),
('NC201902','BH000002',2,'MT0001'),
('NC201903','BH000003',2,'MT0001'),
('NC201904','BH000004',2,'MT0001');

-- BẢNG 25 --VONGBANKET
INSERT INTO VONGBANKET(STTVONGTHI,MAMUATHI,NAM_NU) VALUES
(3,'MT0001',0),
(7,'MT0002',0),
(11,'MT0003',0),
(15,'MT0004',0);

-- BẢNG 26 --THISINHTHAMGIAVONGBANKET
INSERT INTO THISINHTHAMGIAVONGBANKET(STTVONGTHI,MAMUATHI,MATHISINH,MSBC,TONGSOTINNHAN) VALUES
(3,'MT0001','TS2001000001','01',10780),
(3,'MT0001','TS1997000002','02',26080),
(3,'MT0001','TS2000000003','03',64230),
(3,'MT0001','TS1999000004','04',45620);

-- BẢNG 27 --THISINHHATTAIVONGBANKET
INSERT INTO THISINHHATTAIVONGBANKET(MATHISINH,MABAIHAT,STTVONGTHI,MAMUATHI) VALUES
('TS2001000001','BH000002',3,'MT0001'),
('TS1997000002','BH000001',3,'MT0001'),
('TS2000000003','BH000006',3,'MT0001'),
('TS1999000004','BH000005',3,'MT0001');

-- BẢNG 28 --VONGGALA
INSERT INTO VONGGALA(STTVONGTHI,MAMUATHI,CHUDE,MANGUOIHUONGDAN,HATDOIFLAG) VALUES
(4,'MT0001',N'GIA ĐÌNH','NS000006',0),
(8,'MT0002',N'XÃ HỘI','NS000007',0),
(12,'MT0003',N'TÌNH YÊU','NS000008',1),
(16,'MT0004',N'HỌC TRÒ','NS000006',0);

-- BẢNG 29 --THISINHTHAMGIAVONGGALA
INSERT INTO THISINHTHAMGIAVONGGALA(STTVONGTHI,MAMUATHI,MATHISINH,MSBC,TONGSOTINNHAN) VALUES
(4,'MT0001','TS2001000001','01',101230),
(4,'MT0001','TS1997000002','02',364126),
(4,'MT0001','TS2000000003','03',516561),
(4,'MT0001','TS1999000004','04',265962);

-- BẢNG 30 --THISINHHATTAIVONGGALA
INSERT INTO THISINHHATTAIVONGGALA(MATHISINH,MABAIHAT,STTVONGTHI,MAMUATHI) VALUES
('TS2001000001','BH000002',4,'MT0001'),
('TS1997000002','BH000006',4,'MT0001'),
('TS2000000003','BH000003',4,'MT0001'),
('TS1999000004','BH000001',4,'MT0001');

--II. Update (0.25đ)
--Cập nhật tổng số tin nhắn của thí sinh TS2012000001 tại vòng gala 1 (tên vòng thi là gala 1) mùa giải 
--2012 là 10000
UPDATE THISINHTHAMGIAVONGGALA SET TONGSOTINNHAN = 10000 WHERE MATHISINH = 'TS2012000001' AND 
		MAMUATHI IN (SELECT MAMUATHI FROM VONGTHI WHERE YEAR(THOIGIANBATDAU) = 2012 AND TENVONGTHI = N'GALA 1')
		AND STTVONGTHI IN (SELECT STTVONGTHI FROM VONGTHI WHERE YEAR(THOIGIANBATDAU) = 2012 AND TENVONGTHI = N'GALA 1');

--III. Delete (0.25đ)
--Xoá thí sinh có mã TS2012000001 trong bảng thí sinh (bảng 2).
--Hãy cho biết, việc xóa dữ liệu này trong trường hợp nào sẽ được thực hiện thành công, trong trường hợp 
--nào không thành công, và khi đó những bảng dữ liệu nào sẽ bị ảnh hưởng bởi thao tác xóa này. Giải 
--thích.
--
DELETE FROM THISINHHATTAIVONGGALA WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINHTHAMGIAVONGGALA WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINHHATTAIVONGBANKET WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINHTHAMGIAVONGBANKET WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINHHATTAIVONGNHAHAT WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINHHATTAIVONGTHUGIONG WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINHTHAMGIAVONGTHUGIONG WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINHTHAMGIAVONGTHI WHERE MATHISINH = 'TS2012000001'
DELETE FROM THISINH WHERE MATHISINH = 'TS2012000001'
--
-- Trường hợp xóa thành công thí sinh có mã số 'TS2012000001' trong bảng THISINH khi không có những bảng tham chiếu đến bảng thí 
-- sinh có giá trị là 'TS2012000001'.
--
-- Tức là trong các bảng THISINHHATTAIVONGGALA,THISINHTHAMGIAVONGGALA,THISINHHATTAIVONGBANKET,THISINHTHAMGIAVONGBANKET,THISINHHATTAIVONGNHAHAT
-- THISINHHATTAIVONGTHUGIONG,THISINHTHAMGIAVONGTHUGIONG,THISINHTHAMGIAVONGTHI không có trường giá trị MATHISINH = 'TS2012000001'.
--
-- Các bảng bị ảnh hưởng khi xóa là bảng THISINHHATTAIVONGGALA,THISINHTHAMGIAVONGGALA,THISINHHATTAIVONGBANKET,THISINHTHAMGIAVONGBANKET,
-- THISINHHATTAIVONGNHAHAT,THISINHHATTAIVONGTHUGIONG,THISINHTHAMGIAVONGTHUGIONG,THISINHTHAMGIAVONGTHI.
--

--IV. Select (1.25đ)
--a. Tìm thí sinh (CMND, tên, địa chỉ, điện thoại) quán quân mùa giải 2012 (năm bắt đầu của mùa thi là 2012). (0.25đ)
SELECT N.CMND, N.TEN, TS.DIACHI, TS.DIENTHOAI FROM THISINH AS TS , NGUOI AS N, VONGTHI AS VT, THISINHTHAMGIAVONGGALA AS GALA
	WHERE TS.MATHISINH = N.ID AND VT.MAMUATHI = GALA.MAMUATHI AND VT.STTVONGTHI = GALA.STTVONGTHI AND 
	YEAR(VT.THOIGIANBATDAU) = 2012 AND TS.MATHISINH = GALA.MATHISINH AND GALA.TONGSOTINNHAN = (SELECT MAX(TONGSOTINNHAN) FROM
	THISINHTHAMGIAVONGGALA) 

-- b. Cho biết mùa thi nào (mã mùa thi, năm bắt đầu, năm kết thúc) có tổng lượng tin nhắn cho các thí 
--	sinh trong tất cả các vòng thi bán kết và chung kết nhiều nhất kèm theo số lượng tin nhắn của mùa 
--	thi đó. (0.5đ)
SELECT TOP(1) VT.MAMUATHI, MUATHI.NGAYBATDAU, MUATHI.NGAYKETTHUC, SUM(BK.TONGSOTINNHAN) +
			SUM(GL.TONGSOTINNHAN) AS TONGSOTINNHAN FROM
			VONGTHI AS VT FULL JOIN THISINHTHAMGIAVONGBANKET AS BK ON (VT.MAMUATHI = BK.MAMUATHI AND VT.STTVONGTHI
			= BK.STTVONGTHI) FULL JOIN THISINHTHAMGIAVONGGALA AS GL ON (VT.MAMUATHI = GL.MAMUATHI
			AND	VT.STTVONGTHI = GL.STTVONGTHI) FULL JOIN MUATHI ON VT.MAMUATHI = MUATHI.MAMUATHI
			GROUP BY VT.MAMUATHI, MUATHI.NGAYBATDAU, MUATHI.NGAYKETTHUC
			ORDER BY SUM(BK.TONGSOTINNHAN) + SUM(GL.TONGSOTINNHAN) DESC

-- c. Cho biết thí sinh (CMND, tên, địa chỉ, điện thoại) đã tham gia cuộc thi Vietnam idol nhiều lần nhất 
--   kèm theo số lần tham dự và thành tích tốt nhất của thí sinh đó là lọt tới loại vòng thi nào (thử giọng, 
--   nhà hát, bán kết, gala). (0.5đ)
DECLARE @TSMAX CHAR(12)
DECLARE @NUM INT
DECLARE @BEST NVARCHAR(255)
SET @TSMAX = (SELECT TOP(1) TS.CMND FROM THISINHTHAMGIAVONGTHUGIONG INNER JOIN THISINH AS TS ON THISINHTHAMGIAVONGTHUGIONG.MATHISINH = TS.MATHISINH
	GROUP BY TS.CMND
	ORDER BY COUNT(*) DESC)
SET @NUM = (SELECT COUNT(*) FROM THISINHTHAMGIAVONGTHUGIONG AS TG INNER JOIN THISINH AS TS ON TG.MATHISINH = TS.MATHISINH WHERE TS.CMND = @TSMAX)
SET @BEST = N'THỬ GIỌNG'
IF EXISTS (SELECT*FROM THISINHHATTAIVONGNHAHAT AS NH INNER JOIN THISINH AS TS ON NH.MATHISINH = TS.MATHISINH WHERE TS.CMND = @TSMAX)
	SET @BEST = N'NHÀ HÁT'
IF EXISTS (SELECT*FROM THISINHTHAMGIAVONGBANKET AS BK INNER JOIN THISINH AS TS ON BK.MATHISINH = TS.MATHISINH WHERE TS.CMND = @TSMAX)
	SET @BEST = N'BÁN KẾT'
IF EXISTS (SELECT*FROM THISINHTHAMGIAVONGGALA AS GL INNER JOIN THISINH AS TS ON GL.MATHISINH = TS.MATHISINH WHERE TS.CMND = @TSMAX)
	SET @BEST = N'GALA'

SELECT TOP(1) N.CMND, N.TEN, TS.DIACHI, TS.DIENTHOAI, @NUM AS SOMUATHI, @BEST AS THANHTICHTOTNHAT 
		FROM THISINH AS TS INNER JOIN NGUOI AS N ON N.ID = TS.MATHISINH WHERE TS.CMND = @TSMAX
/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/
--PHẦN 4: PHÂN QUYỀN TRUY CẬP (1đ)
--I. Tạo user (0.25đ)
SP_ADDLOGIN 'Nhanvien','123','COMPETITION'
GO
SP_ADDLOGIN 'Quanly','123','COMPETITION'
GO
--II. Phân quyền truy cập, sử dụng (0.75đ)
--1. Gán quyền kết nối vào CSDL cho tất cả các user trên. (0.25đ)
SP_ADDUSER 'Nhanvien','Nhanvien'
GO
SP_ADDUSER 'Quanly','Quanly'
GO
--2. User Nhanvien có các quyền select, insert, update, delete trên tất cả các bảng, ngoại trừ các bảng 19, 
--		20, 22, 23, 24, 26, 27, 29, 30 chỉ được quyền select và insert. (0.25đ)

-----------------------------PHÂN QUYỀN CHO NHÂN VIÊN
USE COMPETITION
--BẢNG  1
GRANT SELECT,INSERT,UPDATE,DELETE ON NGUOI TO Nhanvien
GO
--BẢNG 2
GRANT SELECT,INSERT,UPDATE,DELETE ON THISINH TO Nhanvien
GO
--BẢNG 3
GRANT SELECT,INSERT,UPDATE,DELETE ON NGHESY TO Nhanvien
GO
-- BẢNG 4
GRANT SELECT,INSERT,UPDATE,DELETE ON CHUONGTRINHMCDAN TO Nhanvien
GO
-- BẢNG 5
GRANT SELECT,INSERT,UPDATE,DELETE ON ALBUMCASY TO Nhanvien
GO
-- BẢNG 6
GRANT SELECT,INSERT,UPDATE,DELETE ON BAIHAT TO Nhanvien
GO
-- BẢNG 7
GRANT SELECT,INSERT,UPDATE,DELETE ON THELOAI TO Nhanvien
GO
-- BẢNG 8
GRANT SELECT,INSERT,UPDATE,DELETE ON BAIHATTHUOCTHELOAI TO Nhanvien
GO
-- BẢNG 9
GRANT SELECT,INSERT,UPDATE,DELETE ON NHACSYSANGTAC TO Nhanvien
GO
-- BẢNG 10
GRANT SELECT,INSERT,UPDATE,DELETE ON TINHTHANH TO Nhanvien
GO
-- BẢNG 11
GRANT SELECT,INSERT,UPDATE,DELETE ON NHASANXUAT TO Nhanvien
GO
-- BẢNG 12
GRANT SELECT,INSERT,UPDATE,DELETE ON KENHTRUYENHINH TO Nhanvien
GO
-- BẢNG 13
GRANT SELECT,INSERT,UPDATE,DELETE ON MUATHI TO Nhanvien
GO
-- BẢNG 14
GRANT SELECT,INSERT,UPDATE,DELETE ON GIUBANQUYENMUATHI TO Nhanvien
GO
-- BẢNG 15
GRANT SELECT,INSERT,UPDATE,DELETE ON PHATSONG TO Nhanvien
GO
-- BẢNG 16
GRANT SELECT,INSERT,UPDATE,DELETE ON VONGTHI TO Nhanvien
GO
-- BẢNG 17
GRANT SELECT,INSERT,UPDATE,DELETE ON THISINHTHAMGIAVONGTHI TO Nhanvien
GO
-- BẢNG 18
GRANT SELECT,INSERT,UPDATE,DELETE ON VONGTHUGIONG TO Nhanvien
GO
-- BẢNG 19 --
GRANT SELECT,INSERT ON THISINHTHAMGIAVONGTHUGIONG TO Nhanvien
GO
-- BẢNG 20 --
GRANT SELECT,INSERT ON THISINHHATTAIVONGTHUGIONG TO Nhanvien
GO
-- BẢNG 21
GRANT SELECT,INSERT,UPDATE,DELETE ON VONGNHAHAT TO Nhanvien
GO
-- BẢNG 22 --
GRANT SELECT,INSERT ON THISINHHATTAIVONGNHAHAT TO Nhanvien
GO
-- BẢNG 23 --
GRANT SELECT,INSERT ON NHOMCA TO Nhanvien
GO
-- BẢNG 24 --
GRANT SELECT,INSERT ON NHOMCAHATBAIHAT  TO Nhanvien
GO
-- BẢNG 25
GRANT SELECT,INSERT,UPDATE,DELETE ON VONGBANKET TO Nhanvien
GO
-- BẢNG 26 --
GRANT SELECT,INSERT ON THISINHTHAMGIAVONGBANKET TO Nhanvien
GO
-- BẢNG 27 --
GRANT SELECT,INSERT ON THISINHHATTAIVONGBANKET TO Nhanvien
GO
-- BẢNG 28
GRANT SELECT,INSERT,UPDATE,DELETE ON VONGGALA TO Nhanvien
GO
-- BẢNG 29 --
GRANT SELECT,INSERT ON THISINHTHAMGIAVONGGALA TO Nhanvien
GO
-- BẢNG 30 --
GRANT SELECT,INSERT ON THISINHHATTAIVONGGALA TO Nhanvien
GO

----------------------------------------PHÂN QUYỀN CHO QUẢN LÝ
GRANT ALL ON DATABASE::COMPETITION TO Quanly
GO

------------------------------------------------------------------------------------
----/				GIẢI THÍCH VỀ CÂU LỆNH DELETE                            \------
------------------------------------------------------------------------------------
-- 
-- Trường hợp xóa thành công thí sinh có mã số 'TS2012000001' trong bảng THISINH khi không có những bảng tham chiếu đến bảng thí 
-- sinh có giá trị là 'TS2012000001'.
--
-- Tức là trong các bảng THISINHHATTAIVONGGALA,THISINHTHAMGIAVONGGALA,THISINHHATTAIVONGBANKET,THISINHTHAMGIAVONGBANKET,THISINHHATTAIVONGNHAHAT
-- THISINHHATTAIVONGTHUGIONG,THISINHTHAMGIAVONGTHUGIONG,THISINHTHAMGIAVONGTHI không có trường giá trị MATHISINH = 'TS2012000001'.
--
-- Các bảng bị ảnh hưởng khi xóa là bảng THISINHHATTAIVONGGALA,THISINHTHAMGIAVONGGALA,THISINHHATTAIVONGBANKET,THISINHTHAMGIAVONGBANKET,
-- THISINHHATTAIVONGNHAHAT,THISINHHATTAIVONGTHUGIONG,THISINHTHAMGIAVONGTHUGIONG,THISINHTHAMGIAVONGTHI.